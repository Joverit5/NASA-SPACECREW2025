<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NASA SPATIUM – Multiplayer</title>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <style>
      :root {
        --bg: #0a0a14;
        --panel: #0f2130;
        --muted: #9aa7b2;
        --accent: #66ccff;
        --sidebar-width: 380px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        font-family: "Segoe UI", Roboto, system-ui, sans-serif;
        background: var(--bg);
        color: #e6eef6;
        -webkit-font-smoothing: antialiased;
        overflow: hidden;
      }

      .main-container {
        display: flex;
        height: 100vh;
        width: 100vw;
      }

      #sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(180deg, #0f2433, #07121a);
        border-right: 2px solid #1a2332;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        z-index: 100;
        flex-shrink: 0;
      }

      .sidebar-section {
        padding: 12px;
        border-bottom: 1px solid #1a2332;
      }

      .section-title {
        font-size: 16px;
        font-weight: bold;
        color: var(--accent);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      #game-time-section {
        background: rgba(0, 0, 0, 0.3);
      }
      
      #gameTime {
        font-size: 32px;
        font-weight: bold;
        color: var(--accent);
        text-align: center;
        text-shadow: 0 0 10px rgba(102, 204, 255, 0.5);
      }

      #stats-section {
        background: rgba(0, 0, 0, 0.2);
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        font-size: 13px;
      }

      .stat-label {
        color: var(--muted);
      }

      .stat-value {
        color: #fff;
        font-weight: bold;
      }

      #missions-section {
        flex: 1;
        min-height: 200px;
        overflow-y: auto;
      }
      
      .mission-card {
        background: #1a1f3a;
        border: 2px solid #666;
        border-radius: 6px;
        padding: 8px;
        margin-bottom: 8px;
        font-size: 12px;
      }

      .mission-card.active {
        background: #2a2a00;
        border-color: #ffd93d;
      }

      .mission-card.completed {
        background: #1a3a1a;
        border-color: #4caf50;
      }

      .mission-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .mission-name {
        font-weight: bold;
        font-size: 13px;
      }

      .mission-status {
        font-size: 10px;
        opacity: 0.8;
      }

      .mission-description {
        color: var(--muted);
        margin-bottom: 4px;
        font-size: 11px;
      }

      .mission-area {
        color: var(--accent);
        font-size: 11px;
        margin-bottom: 4px;
      }

      .mission-progress-bar {
        background: #0b0b0b;
        border-radius: 3px;
        height: 4px;
        overflow: hidden;
        margin-bottom: 2px;
      }

      .mission-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #666, #888);
        transition: width 0.3s;
      }

      .mission-card.active .mission-progress-fill {
        background: linear-gradient(90deg, #ffd93d, #ffed4e);
      }

      .mission-card.completed .mission-progress-fill {
        background: linear-gradient(90deg, #4caf50, #66bb6a);
      }

      .mission-progress-text {
        font-size: 10px;
        text-align: right;
        color: var(--muted);
      }

      #events-section {
        max-height: 250px;
        overflow-y: auto;
      }

      .event-card {
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid var(--accent);
        padding: 8px;
        margin-bottom: 6px;
        border-radius: 4px;
        font-size: 12px;
        transition: all 0.3s;
      }

      .event-header {
        font-weight: bold;
        margin-bottom: 4px;
      }

      .event-description {
        color: var(--muted);
        font-size: 11px;
        margin-bottom: 4px;
      }

      .event-timer {
        color: #ffd93d;
        font-size: 11px;
        margin-bottom: 4px;
      }

      .event-resolve-btn {
        margin-top: 4px;
        background: var(--accent);
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        color: #000;
        font-size: 11px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
      }

      .event-resolve-btn:hover {
        background: #88ddff;
        transform: scale(1.05);
      }

      #game-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #000;
        overflow: hidden;
        position: relative;
      }
      
      #game-container {
        flex: 1;
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #0a0a14;
      }

      #game-container canvas {
        display: block;
        width: 100% !important;
        height: 100% !important;
      }

      #btn_start_sim_html {
        position: fixed;
        bottom: 224px;
        right: 24px;
        padding: 16px 28px;
        background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
        border: none;
        border-radius: 10px;
        color: #000;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        z-index: 2000;
        box-shadow: 0 0 25px rgba(0, 217, 255, 0.6);
        transition: all 0.3s ease;
      }

      #btn_start_sim_html:hover {
        transform: scale(1.05);
        box-shadow: 0 0 35px rgba(0, 217, 255, 0.8);
      }

      #btn_start_sim_html:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #666;
      }

      #chat-panel {
        height: 200px;
        background: linear-gradient(180deg, #0f2433, #07121a);
        border-top: 2px solid #1a2332;
        display: flex;
        flex-direction: column;
        padding: 10px;
        flex-shrink: 0;
      }

      #chat-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        color: var(--accent);
        margin-bottom: 8px;
        font-size: 14px;
      }

      #status {
        font-size: 11px;
        color: var(--muted);
        margin-left: auto;
      }

      #status.connected {
        color: #00ffb3;
      }

      #status.error {
        color: #ff4444;
      }

      #messages {
        flex: 1;
        background: rgba(10, 16, 24, 0.6);
        border-radius: 6px;
        padding: 8px;
        overflow-y: auto;
        font-size: 12px;
      }

      .message {
        margin: 4px 0;
        padding: 6px;
        border-radius: 4px;
        word-break: break-word;
      }

      .you {
        background: #052f2a;
        color: #bfffe6;
      }

      .other {
        background: #372a10;
        color: #ffd97a;
      }

      .system {
        text-align: center;
        color: var(--muted);
        font-style: italic;
        background: transparent;
        padding: 4px;
      }

      #input-container {
        display: flex;
        gap: 6px;
        margin-top: 6px;
      }

      #chat-input {
        flex: 1;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #223;
        background: #07121a;
        color: #eaf6ff;
        font-size: 12px;
      }

      #chat-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #chat-send {
        background: var(--accent);
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        color: #012;
        font-weight: bold;
        cursor: pointer;
        font-size: 12px;
      }

      #chat-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #666;
      }

      /* Modal for connection */
      #connection-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }

      #connection-modal.hidden {
        display: none;
      }

      .modal-content {
        background: linear-gradient(180deg, #0f2433, #07121a);
        border: 2px solid var(--accent);
        border-radius: 12px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 0 30px rgba(102, 204, 255, 0.5);
      }

      .modal-content h2 {
        color: var(--accent);
        margin-bottom: 20px;
        text-align: center;
      }

      .modal-content input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        background: #0a0a14;
        border: 2px solid #1a2332;
        border-radius: 6px;
        color: #e6eef6;
        font-size: 14px;
      }

      .modal-content input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .modal-content button {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        background: var(--accent);
        border: none;
        border-radius: 6px;
        color: #000;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .modal-content button:hover {
        transform: scale(1.02);
        box-shadow: 0 0 15px rgba(102, 204, 255, 0.7);
      }

      .modal-content button.secondary {
        background: #1a2332;
        color: var(--accent);
      }

      .modal-error {
        color: #ff4444;
        text-align: center;
        margin-top: 10px;
        font-size: 12px;
      }

      .modal-info {
        color: var(--muted);
        text-align: center;
        margin-bottom: 15px;
        font-size: 12px;
      }

      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 3px;
      }

      @media (max-width: 1200px) {
        :root {
          --sidebar-width: 320px;
        }
      }

      #loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--accent);
        font-size: 18px;
        text-align: center;
        z-index: 1;
      }

      #loading-indicator.hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <!-- Connection Modal -->
    <div id="connection-modal">
      <div class="modal-content">
        <h2>🚀 NASA SPATIUM</h2>
        <div id="modal-step-1">
          <p class="modal-info">Enter your name to join</p>
          <input type="text" id="player-name-input" placeholder="Your name (1-20 characters)" maxlength="20" />
          <button onclick="submitName()">Continue</button>
          <div id="name-error" class="modal-error"></div>
        </div>
        <div id="modal-step-2" style="display: none;">
          <p class="modal-info">Create a new session or join existing</p>
          <button onclick="createSession()">Create New Session</button>
          <button onclick="showJoinInput()" class="secondary">Join Existing Session</button>
          <div id="join-input-section" style="display: none; margin-top: 15px;">
            <input type="text" id="session-id-input" placeholder="Enter Session ID" />
            <button onclick="joinSession()">Join Session</button>
            <button onclick="hideJoinInput()" class="secondary">Back</button>
          </div>
          <div id="session-error" class="modal-error"></div>
        </div>
        <div id="modal-connecting" style="display: none; text-align: center;">
          <p class="modal-info">⏳ Connecting...</p>
        </div>
      </div>
    </div>

    <div class="main-container">
      <!-- SIDEBAR -->
      <aside id="sidebar">
        <div id="game-time-section" class="sidebar-section">
          <div class="section-title">⏱️ Time</div>
          <div id="gameTime">00:00</div>
        </div>
        
        <div id="missions-section" class="sidebar-section">
          <div class="section-title">
            📋 Missions
            <span id="mission-counter">(0/0)</span>
          </div>
          <div id="missions-list">
            <div style="text-align: center; color: #9aa7b2; padding: 20px;">
              No missions assigned
            </div>
          </div>
        </div>

        <div id="events-section" class="sidebar-section">
          <div class="section-title">⚠️ Active Events</div>
          <div id="events-list">
            <div style="text-align: center; color: #9aa7b2; padding: 10px;">
              No events
            </div>
          </div>
        </div>
      </aside>

      <!-- GAME AREA -->
      <div id="game-area">
        <div id="game-container">
          <div id="loading-indicator">
            <div>🚀 Loading NASA SPATIUM...</div>
            <div style="font-size: 14px; margin-top: 10px;">Initializing systems</div>
          </div>
        </div>
        
        <button id="btn_start_sim_html" disabled>🚀 Start Mission</button>
        
        <div id="chat-panel">
          <div id="chat-header">
            💬 Space Chat
            <span id="status">Connecting...</span>
          </div>
          <div id="messages"></div>
          <div id="input-container">
            <input id="chat-input" placeholder="Type a message..." disabled />
            <button id="chat-send" disabled>Send</button>
          </div>
        </div>
      </div>
    </div>

    <script src="/budgetSystem.js"></script>
    <script src="/mission-bank.js"></script>
    <script src="/missions.js"></script>
    <script src="/missionSystem.js"></script>
    <script src="/events.js"></script>
    <script src="/main.js"></script>

    <script>
      console.log('🔍 Checking dependencies...');
      console.log('- Phaser:', typeof Phaser !== 'undefined' ? '✅' : '❌');
      console.log('- Socket.io:', typeof io !== 'undefined' ? '✅' : '❌');
      console.log('- BudgetSystem:', typeof window.BudgetSystem !== 'undefined' ? '✅' : '❌');
      console.log('- EventSystem:', typeof window.eventSystem !== 'undefined' ? '✅' : '❌');
      console.log('- MissionSystem:', typeof window.MissionSystem !== 'undefined' ? '✅' : '❌');

      // Global multiplayer state
      window.SESSION_ID = null;
      window.PLAYER_ID = null;
      window.IS_HOST = false;
      window.PLAYER_ROLE = null;
      window.PLAYER_NAME = null;

      let socket = null;
      let isConnected = false;

      function waitForGame(callback) {
        if (typeof Phaser !== 'undefined' && window._mainLoaded) {
          callback();
        } else {
          setTimeout(() => waitForGame(callback), 100);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        console.log("📄 DOM loaded, waiting for game...");
        
        waitForGame(() => {
          console.log("✅ Game ready, initializing multiplayer...");
          
          const loadingIndicator = document.getElementById("loading-indicator");
          if (loadingIndicator) {
            loadingIndicator.classList.add("hidden");
          }
          
          initMultiplayer();
        });
      });

      function showError(elementId, message) {
        const errorEl = document.getElementById(elementId);
        if (errorEl) {
          errorEl.textContent = message;
          setTimeout(() => {
            errorEl.textContent = '';
          }, 3000);
        }
      }

      function submitName() {
        const nameInput = document.getElementById("player-name-input");
        const name = nameInput.value.trim();
        
        if (!name || name.length === 0) {
          showError('name-error', 'Please enter a name');
          return;
        }
        
        if (name.length > 20) {
          showError('name-error', 'Name too long (max 20 characters)');
          return;
        }
        
        window.PLAYER_NAME = name;
        document.getElementById("modal-step-1").style.display = "none";
        document.getElementById("modal-step-2").style.display = "block";
      }

      function showJoinInput() {
        document.getElementById("join-input-section").style.display = "block";
      }

      function hideJoinInput() {
        document.getElementById("join-input-section").style.display = "none";
        document.getElementById("session-id-input").value = "";
      }

      function createSession() {
        const sessionId = 'session_' + Date.now();
        window.SESSION_ID = sessionId;
        
        document.getElementById("modal-step-2").style.display = "none";
        document.getElementById("modal-connecting").style.display = "block";
        
        console.log('Creating session:', sessionId);
        if (socket && socket.connected) {
          socket.emit("create_session", { sessionId, playerName: window.PLAYER_NAME });
        } else {
          showError('session-error', 'Not connected to server');
          document.getElementById("modal-step-2").style.display = "block";
          document.getElementById("modal-connecting").style.display = "none";
        }
      }

      function joinSession() {
        const sessionInput = document.getElementById("session-id-input");
        const sessionId = sessionInput.value.trim();
        
        if (!sessionId) {
          showError('session-error', 'Please enter a session ID');
          return;
        }
        
        window.SESSION_ID = sessionId;
        
        document.getElementById("modal-step-2").style.display = "none";
        document.getElementById("modal-connecting").style.display = "block";
        
        console.log('Joining session:', sessionId);
        if (socket && socket.connected) {
          socket.emit("join_session", { 
            sessionId, 
            player: { name: window.PLAYER_NAME } 
          });
        } else {
          showError('session-error', 'Not connected to server');
          document.getElementById("modal-step-2").style.display = "block";
          document.getElementById("modal-connecting").style.display = "none";
        }
      }

      function initMultiplayer() {
        const SERVER_URL = window.location.origin;
        socket = io(SERVER_URL);
        window.socket = socket;

        const statusDiv = document.getElementById("status");
        const messagesDiv = document.getElementById("messages");
        const inputEl = document.getElementById("chat-input");
        const sendBtn = document.getElementById("chat-send");
        const gameTimeEl = document.getElementById("gameTime");
        const startBtn = document.getElementById("btn_start_sim_html");

        let gameStartTime = null;

        function setStatus(text, cls = "") {
          statusDiv.textContent = text;
          statusDiv.className = cls;
        }

        function addSystem(text) {
          const d = document.createElement("div");
          d.className = "message system";
          d.textContent = text;
          messagesDiv.appendChild(d);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessage(msg) {
          const d = document.createElement("div");
          d.className = "message " + (msg.playerId === window.PLAYER_ID ? "you" : "other");
          d.textContent = (msg.playerId === window.PLAYER_ID ? "[You] " : `[${msg.playerName}] `) + msg.text;
          messagesDiv.appendChild(d);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showErrorMessage(text) {
          const d = document.createElement("div");
          d.className = "message system";
          d.style.color = "#ff6b6b";
          d.textContent = "❌ " + text;
          messagesDiv.appendChild(d);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateGameTime() {
          if (!gameStartTime) return;
          const elapsed = Date.now() - gameStartTime;
          const minutes = Math.floor(elapsed / 60000);
          const seconds = Math.floor((elapsed % 60000) / 1000);
          gameTimeEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        socket.on("connect", () => {
          console.log("✅ Socket connected:", socket.id);
          setStatus("Connected", "connected");
          isConnected = true;
          
          // Show modal only after connection
          document.getElementById("connection-modal").classList.remove("hidden");
        });

        socket.on("join_success", (data) => {
          console.log("✅ Join success:", data);
          window.PLAYER_ID = data.playerId;
          window.IS_HOST = data.isHost;
          window.PLAYER_ROLE = data.player?.role || 'crew';
          
          // Hide modal
          document.getElementById("connection-modal").classList.add("hidden");
          
          setStatus(`${data.playerName} (${data.player?.role || 'crew'})`, "connected");
          inputEl.disabled = false;
          sendBtn.disabled = false;
          
          if (data.isHost) {
            startBtn.disabled = false;
            addSystem(`✅ You are the HOST. You can place areas and start the mission.`);
          } else {
            addSystem(`✅ You joined as ${data.player?.role}. Only the host can edit areas.`);
          }
          
          addSystem(`🔑 Session: ${data.sessionId}`);
          
          if (window.onMultiplayerReady) {
            window.onMultiplayerReady(data);
          }
        });

        socket.on("join_rejected", (data) => {
          console.error("❌ Join rejected:", data);
          showError('session-error', data.message);
          
          // Go back to step 2
          document.getElementById("modal-connecting").style.display = "none";
          document.getElementById("modal-step-2").style.display = "block";
          
          if (data.reason === "name_taken") {
            // Go back to step 1 to change name
            document.getElementById("modal-step-2").style.display = "none";
            document.getElementById("modal-step-1").style.display = "block";
            showError('name-error', 'Name already taken. Please choose another.');
          }
        });

        socket.on("chat_history", (messages) => {
          if (!messages || !messages.length) return;
          addSystem(`--- Chat History (${messages.length}) ---`);
          messages.forEach((m) => addMessage(m));
        });

        socket.on("chat_message_broadcast", (msg) => {
          addMessage(msg);
        });

        socket.on("player_joined", (data) => {
          addSystem(`👤 ${data.player?.name || 'Player'} joined as ${data.player?.role || 'crew'}`);
        });

        socket.on("player_left", (data) => {
          addSystem(`👋 ${data.playerName || data.name || 'Player'} left the session`);
        });

        socket.on("mission_started", (data) => {
          console.log("🚀 Mission started:", data);
          gameStartTime = data.timestamp;
          setInterval(updateGameTime, 1000);
          addSystem("🚀 Mission started!");
          startBtn.disabled = true;
          startBtn.textContent = "⚡ Mission In Progress";
          
          if (window.onMissionStarted) {
            window.onMissionStarted(data);
          }
        });

        socket.on("disconnect", () => {
          console.warn("⚠️ Disconnected from server");
          setStatus("Disconnected", "error");
          inputEl.disabled = true;
          sendBtn.disabled = true;
          startBtn.disabled = true;
          addSystem("⚠️ Connection lost");
          isConnected = false;
        });

        socket.on("error", (error) => {
          console.error("❌ Socket error:", error);
          showErrorMessage("Connection error: " + error);
        });

        sendBtn.addEventListener("click", sendChat);
        inputEl.addEventListener("keypress", (ev) => {
          if (ev.key === "Enter") {
            ev.preventDefault();
            sendChat();
          }
        });

        function sendChat() {
          if (!isConnected || !window.PLAYER_ID) {
            showErrorMessage("Not connected to server");
            return;
          }
          const text = inputEl.value.trim();
          if (!text || text.length > 500) return;
          
          socket.emit("chat_message", { 
            sessionId: window.SESSION_ID, 
            playerId: window.PLAYER_ID, 
            text 
          });
          inputEl.value = "";
        }

        startBtn.addEventListener("click", () => {
          if (!window.IS_HOST) {
            showErrorMessage("Only the host can start the mission");
            return;
          }
          
          console.log("Starting mission...");
          socket.emit("start_mission", { sessionId: window.SESSION_ID });
        });
        
        // Allow Enter key on name input
        document.getElementById("player-name-input").addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            submitName();
          }
        });
        
        // Allow Enter key on session input
        document.getElementById("session-id-input").addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            joinSession();
          }
        });
        
        console.log('✅ Multiplayer system initialized');
      }
    </script>
  </body>
</html>