<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NASA SPATIUM ‚Äì Multiplayer + Chat</title>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="/events.js"></script>
    <script src="/mission-bank.js"></script>
    <script src="/missions.js"></script>
    <script src="/missionSystem.js"></script> 
    <script src="/budgetSystem.js"></script>

    <style>
      :root {
        --bg: #0a0a14;
        --panel: #0f2130;
        --muted: #9aa7b2;
        --accent: #66ccff;
        --sidebar-width: 380px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
        font-family: "Segoe UI", Roboto, system-ui, sans-serif;
        background: var(--bg);
        color: #e6eef6;
        -webkit-font-smoothing: antialiased;
        overflow: hidden;
      }

      .main-container {
        display: flex;
        height: 100vh;
      }

      #sidebar {
        width: var(--sidebar-width);
        background: linear-gradient(180deg, #0f2433, #07121a);
        border-right: 2px solid #1a2332;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        z-index: 100;
      }

      .sidebar-section {
        padding: 12px;
        border-bottom: 1px solid #1a2332;
      }

      .section-title {
        font-size: 16px;
        font-weight: bold;
        color: var(--accent);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      #game-time-section {
        background: rgba(0, 0, 0, 0.3);
      }
      
      #game {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      
      #gameTime {
        font-size: 32px;
        font-weight: bold;
        color: var(--accent);
        text-align: center;
        text-shadow: 0 0 10px rgba(102, 204, 255, 0.5);
      }

      #stats-section {
        background: rgba(0, 0, 0, 0.2);
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        font-size: 13px;
      }

      .stat-label {
        color: var(--muted);
      }

      .stat-value {
        color: #fff;
        font-weight: bold;
      }

      #missions-section {
        flex: 1;
        min-height: 200px;
        overflow-y: auto;
      }
      
      #game canvas {
        width: 100% !important;
        height: 100% !important;
        object-fit: contain;
        display: block;
      }
      
      .mission-card {
        background: #1a1f3a;
        border: 2px solid #666;
        border-radius: 6px;
        padding: 8px;
        margin-bottom: 8px;
        font-size: 12px;
      }

      .mission-card.active {
        background: #2a2a00;
        border-color: #ffd93d;
      }

      .mission-card.completed {
        background: #1a3a1a;
        border-color: #4caf50;
      }

      .mission-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .mission-name {
        font-weight: bold;
        font-size: 13px;
      }

      .mission-status {
        font-size: 10px;
        opacity: 0.8;
      }

      .mission-description {
        color: var(--muted);
        margin-bottom: 4px;
        font-size: 11px;
      }

      .mission-area {
        color: var(--accent);
        font-size: 11px;
        margin-bottom: 4px;
      }

      .mission-progress-bar {
        background: #0b0b0b;
        border-radius: 3px;
        height: 4px;
        overflow: hidden;
        margin-bottom: 2px;
      }

      .mission-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #666, #888);
        transition: width 0.3s;
      }

      .mission-card.active .mission-progress-fill {
        background: linear-gradient(90deg, #ffd93d, #ffed4e);
      }

      .mission-card.completed .mission-progress-fill {
        background: linear-gradient(90deg, #4caf50, #66bb6a);
      }

      .mission-progress-text {
        font-size: 10px;
        text-align: right;
        color: var(--muted);
      }

      #events-section {
        max-height: 250px;
        overflow-y: auto;
      }

      .event-card {
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid var(--accent);
        padding: 8px;
        margin-bottom: 6px;
        border-radius: 4px;
        font-size: 12px;
        transition: all 0.3s;
      }

      .event-header {
        font-weight: bold;
        margin-bottom: 4px;
      }

      .event-description {
        color: var(--muted);
        font-size: 11px;
        margin-bottom: 4px;
      }

      .event-timer {
        color: #ffd93d;
        font-size: 11px;
        margin-bottom: 4px;
      }

      .event-resolve-btn {
        margin-top: 4px;
        background: var(--accent);
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        color: #000;
        font-size: 11px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
      }

      .event-resolve-btn:hover {
        background: #88ddff;
        transform: scale(1.05);
      }

      #event-log-section {
        max-height: 150px;
        overflow-y: auto;
        font-size: 11px;
      }

      .log-item {
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        color: var(--muted);
      }

      #game-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #000;
        overflow: hidden;
      }
      
      #game-container {
        flex: 1;
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      #btn_start_sim_html {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 40px;
        background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
        border: none;
        border-radius: 12px;
        color: #000;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 0 30px rgba(0, 217, 255, 0.6);
        transition: all 0.3s ease;
      }

      #btn_start_sim_html:hover {
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 0 0 40px rgba(0, 217, 255, 0.8);
      }

      #chat-panel {
        height: 200px;
        background: linear-gradient(180deg, #0f2433, #07121a);
        border-top: 2px solid #1a2332;
        display: flex;
        flex-direction: column;
        padding: 10px;
      }

      #chat-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        color: var(--accent);
        margin-bottom: 8px;
        font-size: 14px;
      }

      #status {
        font-size: 11px;
        color: var(--muted);
        margin-left: auto;
      }

      #messages {
        flex: 1;
        background: rgba(10, 16, 24, 0.6);
        border-radius: 6px;
        padding: 8px;
        overflow-y: auto;
        font-size: 12px;
      }

      .message {
        margin: 4px 0;
        padding: 6px;
        border-radius: 4px;
        word-break: break-word;
      }

      .you {
        background: #052f2a;
        color: #bfffe6;
      }

      .other {
        background: #372a10;
        color: #ffd97a;
      }

      .system {
        text-align: center;
        color: var(--muted);
        font-style: italic;
        background: transparent;
        padding: 4px;
      }

      #input-container {
        display: flex;
        gap: 6px;
        margin-top: 6px;
      }

      #chat-input {
        flex: 1;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #223;
        background: #07121a;
        color: #eaf6ff;
        font-size: 12px;
      }

      #chat-send {
        background: var(--accent);
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        color: #012;
        font-weight: bold;
        cursor: pointer;
        font-size: 12px;
      }

      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 3px;
      }

      @media (max-width: 1200px) {
        :root {
          --sidebar-width: 320px;
        }
      }
    </style>
  </head>

  <body>
    <div class="main-container">
      <aside id="sidebar">
        <div id="game-time-section" class="sidebar-section">
          <div class="section-title">‚è±Ô∏è Tiempo de Juego</div>
          <div id="gameTime">00:00</div>
        </div>
        
        <div id="missions-section" class="sidebar-section">
          <div class="section-title">
            üìã Misiones
            <span id="mission-counter" style="font-size: 12px; opacity: 0.7">(0/0)</span>
          </div>
          <div id="missions-list">
            <div style="text-align: center; color: #9aa7b2; font-size: 12px; padding: 20px;">
              Sin misiones asignadas
            </div>
          </div>
        </div>
        
        <div id="hud-controls">
          <button id="btn_start_sim_html">üöÄ Start Simulation</button>
        </div>

        <div id="events-section" class="sidebar-section">
          <div class="section-title">üîî Eventos Activos</div>
          <div id="events-list">
            <div style="text-align: center; color: #9aa7b2; font-size: 12px; padding: 10px;">
              Sin eventos
            </div>
          </div>
        </div>
      </aside>

      <div id="game-area">
        <div id="game-container" style="position: relative; width: 100%; height: 100%">
          <div id="game" style="position: absolute; inset: 0; width: 100%; height: 100%"></div>
        </div>
        
        <script src="/main.js"></script>
        
        <div id="chat-panel">
          <div id="chat-header">
            Chat Espacial
            <span id="status">Conectando...</span>
          </div>
          <div id="messages"></div>
          <div id="input-container">
            <input id="chat-input" placeholder="Escribe un mensaje..." disabled />
            <button id="chat-send" disabled>Enviar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
        const SERVER_URL = isLocal ? location.origin : location.origin;
        const socket = window.socket && typeof window.socket.emit === "function"
          ? window.socket
          : (window.socket = io(SERVER_URL));

        const sessionId = "sala-demo";

        const statusDiv = document.getElementById("status");
        const messagesDiv = document.getElementById("messages");
        const inputEl = document.getElementById("chat-input");
        const sendBtn = document.getElementById("chat-send");
        const gameTimeEl = document.getElementById("gameTime");

        let playerId = null;
        let playerName = null;
        let isConnected = false;
        let isJoining = false;
        let gameStartTime = null;

        function promptForName() {
          let name = prompt("Tu nombre (1-20 caracteres):");
          if (!name) return promptForName();
          name = name.trim();
          if (name.length === 0 || name.length > 20) return promptForName();
          return name;
        }

        function setStatus(text, cls = "") {
          statusDiv.textContent = text;
          statusDiv.className = cls;
        }

        function addSystem(text) {
          const d = document.createElement("div");
          d.className = "message system";
          d.textContent = text;
          messagesDiv.appendChild(d);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addMessage(msg) {
          const d = document.createElement("div");
          d.className = "message " + (msg.playerId === playerId ? "you" : "other");
          d.textContent = (msg.playerId === playerId ? "[Tu] " : `[${msg.playerName}] `) + msg.text;
          messagesDiv.appendChild(d);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showError(text) {
          const d = document.createElement("div");
          d.className = "message system";
          d.style.color = "#ff6b6b";
          d.textContent = "‚ùå " + text;
          messagesDiv.appendChild(d);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function attemptJoin(name) {
          if (isJoining) return;
          isJoining = true;
          setStatus(`Conectando como ${name}...`);
          socket.emit("join_session", { sessionId, player: { name } });
        }

        function updateGameTime() {
          if (!gameStartTime) return;
          const elapsed = Date.now() - gameStartTime;
          const minutes = Math.floor(elapsed / 60000);
          const seconds = Math.floor((elapsed % 60000) / 1000);
          gameTimeEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        socket.on("connect", () => {
          console.log("socket connected", socket.id);
          playerName = promptForName();
          attemptJoin(playerName);
        });

        socket.on("join_success", (data) => {
          playerId = data.playerId;
          isConnected = true;
          isJoining = false;
          setStatus(`Conectado: ${data.playerName}`, "connected");
          inputEl.disabled = false;
          sendBtn.disabled = false;
          addSystem(`Te has unido a ${data.sessionId} como ${data.playerName}`);
        });

        socket.on("join_rejected", (data) => {
          isJoining = false;
          showError(data.message);
          setStatus(data.message, "error");
          if (data.reason === "room_full") {
            inputEl.disabled = true;
            sendBtn.disabled = true;
            addSystem("Sala llena. Intenta mas tarde.");
            setTimeout(() => socket.disconnect(), 400);
            return;
          }
          if (data.reason === "name_taken") {
            setTimeout(() => {
              const newName = promptForName();
              attemptJoin(newName);
            }, 300);
          }
        });

        socket.on("chat_history", (messages) => {
          if (!messages || !messages.length) return;
          addSystem(`--- Historial (${messages.length}) ---`);
          messages.forEach((m) => addMessage(m));
        });

        socket.on("chat_message_broadcast", (msg) => {
          addMessage(msg);
        });

        socket.on("player_joined", (data) => {
          addSystem(`${data.name} se ha unido a la sala`);
        });

        socket.on("player_left", (data) => {
          addSystem(`${data.name} ha salido de la sala`);
        });

        socket.on("chat_error", (data) => {
          showError(data.message || "Error en chat");
          setStatus(`Error: ${data.message}`, "error");
          inputEl.disabled = true;
          sendBtn.disabled = true;
          isConnected = false;
        });

        socket.on("disconnect", () => {
          setStatus("Desconectado", "error");
          inputEl.disabled = true;
          sendBtn.disabled = true;
          addSystem("Conexion perdida con el servidor");
        });

        socket.on("connect_error", (err) => {
          setStatus("Error de conexion", "error");
          showError("No se pudo conectar al servidor");
        });

        sendBtn.addEventListener("click", () => {
          sendChat();
        });
        
        inputEl.addEventListener("keypress", (ev) => {
          if (ev.key === "Enter") {
            ev.preventDefault();
            sendChat();
          }
        });

        function sendChat() {
          if (!isConnected || !playerId) return;
          const text = inputEl.value.trim();
          if (!text) return;
          socket.emit("chat_message", { sessionId, playerId, text });
          inputEl.value = "";
        }

        // Iniciar contador de tiempo cuando se inicia la simulaci√≥n
        const btnStart = document.getElementById("btn_start_sim_html");
        if (btnStart) {
          btnStart.addEventListener("click", () => {
            gameStartTime = Date.now();
            setInterval(updateGameTime, 1000);
          });
        }

        window._spatium = { socket, playerId, sessionId };
      });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('btn_start_sim_html');
        if (btn) {
          btn.addEventListener('click', () => {
            try {
              if (typeof startIsometricTransition === 'function') {
                startIsometricTransition();
              }
            } catch(e) {
              console.warn('startIsometricTransition not available yet', e);
            }
          });
        }
      });

      (function checkDeps(){
        const log = (m) => {
          console.log(`[Check] ${m}`);
        };
        
        if (typeof Phaser === 'undefined') {
          log('ERROR: Phaser no est√° cargado. Revisa la URL del CDN.');
        } else {
          log('Phaser OK: v' + (Phaser.VERSION || 'unknown'));
        }

        if (typeof io === 'undefined') {
          log('AVISO: socket.io cliente no cargado.');
        } else {
          log('socket.io OK');
        }

        if (typeof window._eventsLoaded === 'undefined') {
          log('AVISO: events.js no parece inicializarse correctamente.');
        } else {
          log('events.js OK');
        }

        if (!window._missionsLoaded) {
          log('AVISO: missions.js no parece inicializarse correctamente.');
        } else {
          log('missions.js OK');
        }

        if (!window._mainLoaded) {
          log('AVISO: main.js no parece inicializarse correctamente.');
        } else {
          log('main.js OK');
        }
      })();
    </script>
  </body>
</html>